## 从输入一个 url 到显示出一个完整的页面发生了什么？

前端对于浏览器的了解可以不必像浏览器工程师那样精通，但是也需要达到了解，熟悉工作原理与过程的程度。学习浏览器的内部工作原理，对于性能优化、错误排查都有很大的好处。

### 大致分为 6 步

1. DNS 解析（域名解析）
2. 建立 TCP3 次握手(网络链接)
3. 浏览器首先使用 HTTP 或者 HTTPS 协议向服务端请求页面
4. 把请求回来的 HTML 代码进行解析，构建成为 DOM 树
5. 计算 DOM 树上的属性，形成 CSS 树
6. 最后根据 CSS 属性，对 DOM 树进行渲染，得到内存中的位图
7. （一个可选步骤）对位图进行合成，这会极大的增加后续的绘制速度
8. 合成之后绘制到页面上

从 HTTP 请求回来，就产生了流式的数据，后续的 DOM 树构建、CSS 计算、渲染、合成、绘制，都是尽可能地流式处理前一步的产出：即*不需要等到上一步骤完全结束*，就开始处理上一步的输出，这样我们在浏览网页时，才会看到逐步出现的页面。

- DNS 解析

  [参考：DNS 解析过程](https://www.jianshu.com/p/a877684a4cdd)
  [参考：浏览器工作原理：从 URL 输入到页面展现到底发生了什么？](https://www.jianshu.com/p/d616d887953a)
  [从输入 URL 到浏览器显示页面发生了什么](https://www.cnblogs.com/yuanzhiguo/p/8119470.html)

  DNS 解析的过程就是寻找哪台机器上有你需要资源的过程。DNS 解析是一个递归查找的过程。

  **DNS 优化**：DNS 缓存。DNS 存在着多级缓存，从离浏览器的距离排序的话，有以下几种: 浏览器缓存，系统缓存，路由器缓存，IPS 服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存。

  **DNS 负载均衡**：真实的互联网世界背后存在成千上百台服务器，大型的网站甚至更多。但是在用户的眼中，它需要的只是处理他的请求，哪台机器处理请求并不重要。DNS 可以返回一个合适的机器的 IP 给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是 DNS 负载均衡，又叫做 DNS 重定向。大家耳熟能详的 CDN(Content Delivery Network)就是利用 DNS 的重定向技术，DNS 服务器会返回一个跟用户最接近的点的 IP 地址给用户，CDN 节点的服务器负责响应用户的请求，提供所需的内容。

- 浏览器渲染页面过程

  浏览器是一个边解析边渲染的过程。首先浏览器解析 HTML 文件构建 DOM 树，然后解析 CSS 文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。这个过程比较复杂，涉及到两个概念: **reflow(回流)和 repain(重绘)**。DOM 节点中的各个元素都是以盒模型的形式存在，这些都需要浏览器去计算其位置和大小等，这个过程称为 relow;当盒模型的位置,大小以及其他属性，如颜色,字体,等确定下来之后，浏览器便开始绘制内容，这个过程称为 repain。页面在首次加载时必然会经历 reflow 和 repain。reflow 和 repain 过程是非常消耗性能的，尤其是在移动设备上，它会破坏用户体验，有时会造成页面卡顿。所以我们应该尽可能少的减少 reflow 和 repain。

  JS 的解析是由浏览器中的 JS 解析引擎完成的。JS 是**单线程**运行，也就是说，在同一个时间内只能做一件事，所有的任务都需要排队，前一个任务结束，后一个任务才能开始。但是又存在某些任务比较耗时，如 IO 读写等，所以需要一种机制可以先执行排在后面的任务，这就是：同步任务(synchronous)和异步任务(asynchronous)。JS 的执行机制就可以看做是一个主线程加上一个任务队列(task queue)。**同步任务就是放在主线程上执行的任务，异步任务是放在任务队列中的任务**。所有的同步任务在主线程上执行，形成一个执行栈;异步任务有了运行结果就会在任务队列中放置一个事件；脚本运行时先依次运行执行栈，然后会从任务队列里提取事件，运行任务队列中的任务，这个过程是不断重复的，所以又叫做事件循环(Event loop)。

[参考文章：什么是回流，什么是重绘，有什么区别？](https://www.jianshu.com/p/e081f9aa03fb)
[你真的了解回流和重绘吗](https://segmentfault.com/a/1190000017329980)

- 回流

  浏览器在接收到 HTML 之后，会首先解析构建 DOM 树，同时样式会构成 CSS 树，两者进行结合 构成 渲染树(render tree)。

  当 render tree 中的一部分(或全部)因为元素的规模尺寸，布局，隐藏等改变而需要重新构建。这就称为回流(reflow)。每个页面至少需要一次回流，就是在页面第一次加载的时候，这时候是一定会发生回流的，因为要构建 render tree。在回流的时候，浏览器会使渲染树中受到影响的部分失效，并重新构造这部分渲染树，完成回流后，浏览器会重新绘制受影响的部分到屏幕中，该过程成为重绘。

- 重绘

  当 render tree 中的一些元素需要更新属性，而这些属性只是影响元素的外观，风格，而不会影响布局的，比如 background-color。则就叫称为重绘。

- 回流/重绘区别

  回流必将引起重绘，而重绘不一定会引起回流。比如：只有颜色改变的时候就只会发生重绘而不会引起回流。
  当页面布局和几何属性改变时就需要回流。
  比如：添加或者删除可见的 DOM 元素，元素位置改变，元素尺寸改变——边距、填充、边框、宽度和高度，内容改变。
